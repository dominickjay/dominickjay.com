---
// Alpine component state is set in client script below
---

<div
  class="col-span-full"
  x-data="currentlyPlaying()"
  x-init="fetchTrack(); setInterval(fetchTrack, 30000)"
  aria-live="polite"
>
  <!-- Loading -->
  <div
    x-show="loading"
    x-cloak
    class="col-span-full flex w-full gap-4 items-center p-4 rounded border border-[var(--color-dark)]"
    aria-busy="true"
  >
    <div
      class="size-[100px] shrink-0 bg-[var(--color-dark)] animate-pulse rounded"
    >
    </div>
    <div class="flex flex-col gap-2 flex-1">
      <span class="text-sm text-[var(--color-dark)]">Loadingâ€¦</span>
    </div>
  </div>

  <!-- Nothing playing -->
  <div
    x-show="!loading && (error || !track)"
    x-cloak
    class="col-span-full flex w-full gap-4 items-center p-4 rounded border border-[var(--color-dark)]"
    role="status"
  >
    <span class="text-sm text-[var(--color-dark)]">
      Nothing playing right now.
    </span>
  </div>

  <!-- Track -->
  <div
    x-show="!loading && track"
    x-cloak
    class="artist-card flex w-full gap-4 col-span-full [--track-color:var(--color-dark)]"
  >
    <div
      class="flex justify-between items-baseline gap-2 relative aspect-square size-[150px] shrink-0"
    >
      <img
        x-show="imageUrl"
        :src="imageUrl"
        alt=""
        class="h-full w-full object-cover object-center aspect-square"
        width="250"
        height="250"
        loading="lazy"
      />
      <div x-show="!imageUrl" class="size-full bg-[var(--color-dark)] rounded">
      </div>
      <div
        x-show="isNowPlaying"
        class="now-playing-indicator absolute bottom-1 right-1 flex gap-1"
        aria-hidden="true"
      >
        <span
          class="size-1.5 rounded-full bg-[var(--color-light)] animate-pulse"
        ></span>
        <span
          class="size-1.5 rounded-full bg-[var(--color-light)] animate-pulse [animation-delay:0.2s]"
        ></span>
        <span
          class="size-1.5 rounded-full bg-[var(--color-light)] animate-pulse [animation-delay:0.4s]"
        ></span>
      </div>
    </div>
    <div class="w-full py-4 flex flex-col justify-center min-w-0">
      <span
        class="intro relative font-semibold block truncate"
        x-text="track?.name ?? ''"></span>
      <span
        class="relative lowercase text-[1rem] truncate"
        x-text="track?.artist?.['#text'] ?? ''"></span>
    </div>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    window.Alpine.data("currentlyPlaying", () => ({
      track: null,
      loading: true,
      error: null,

      get imageUrl() {
        if (!this.track?.image) return "";
        const img = this.track.image;
        const arr = Array.isArray(img) ? img : [img];
        for (let i = arr.length - 1; i >= 0; i--) {
          const u = arr[i]?.["#text"]?.trim();
          if (u) return u;
        }
        return "";
      },

      get isNowPlaying() {
        const attr = this.track?.["@attr"];
        return attr?.nowplaying === true || String(attr?.nowplaying) === "true";
      },

      fetchTrack() {
        fetch("/api/recent-tracks")
          .then((r) => r.json())
          .then((data) => {
            const list = data?.recenttracks?.track;
            this.track =
              Array.isArray(list) && list.length > 0 ? list[0] : null;
            this.loading = false;
          })
          .catch((err) => {
            this.error = err;
            this.loading = false;
          });
      },
    }));
  });
</script>
