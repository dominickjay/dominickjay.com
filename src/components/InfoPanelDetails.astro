---
const { ariahidden = false } = Astro.props;

let books: any[] = [];

import {
	getRecentTracksWithTags,
	type LastFmArtist,
	type LastFmTrack,
	type LastFmTag,
} from "../lib/lastfm";

let artists: LastFmArtist[] = [];
let tracks: LastFmTrack[] = [];
let recentTracks: LastFmTrack | null = null;
let recentTrackTags: LastFmTag[] = [];
let trackColor = "#000000"; // Default color

// Simple in-memory cache to avoid rate limiting during development
const cache = new Map<string, { data: any; expires: number }>();
const CACHE_TTL = 30000; // 30 seconds

let allBooks = [];
let backlog = [];
let currentlyReading = [];
let currentList = [];
let currentListCount = 0;
let currentListBooks = [];

const apiKey = import.meta.env.LAST_FM_API_KEY;
const hardcoverToken = (import.meta.env.hardcoverToken ?? "").trim();

function getCached(key: string): any | null {
	const cached = cache.get(key);
	if (cached && cached.expires > Date.now()) {
		return cached.data;
	}
	cache.delete(key);
	return null;
}

function setCached(key: string, data: any): void {
	cache.set(key, { data, expires: Date.now() + CACHE_TTL });
}

// Helper function to make GraphQL requests
async function hardcoverGraphQL(
	query: string,
	variables: any,
	useAuth = false,
) {
	if (useAuth && !hardcoverToken) {
		throw new Error(
			"Hardcover token is required for authenticated requests. " +
				"Please set the hardcoverToken environment variable. " +
				"Get your token from https://hardcover.app/account/api",
		);
	}

	// Create cache key from query and variables
	const cacheKey = JSON.stringify({ query, variables });
	const cached = getCached(cacheKey);
	if (cached) {
		console.log("üíæ Using cached response for query");
		return cached;
	}

	const headers: Record<string, string> = {
		"Content-Type": "application/json",
		"User-Agent": "dominickjay.com/1.0",
	};

	if (useAuth) {
		// Use Bearer prefix for JWT tokens (standard for Hasura/GraphQL APIs)
		headers["authorization"] = hardcoverToken.startsWith("Bearer ")
			? hardcoverToken
			: `Bearer ${hardcoverToken}`;
	}

	// console.log("üåê GraphQL Request:", {
	//   useAuth,
	//   variables,
	//   query: query.substring(0, 100) + "...",
	// });

	const response = await fetch("https://api.hardcover.app/v1/graphql", {
		method: "POST",
		headers,
		body: JSON.stringify({ query, variables }),
	});

	console.log("üåê GraphQL Response status:", response.status);

	if (!response.ok) {
		const errorText = await response.text();
		console.error("üåê GraphQL Error response:", errorText);

		// If rate limited, wait a bit and suggest using cache
		if (response.status === 429) {
			console.warn(
				"‚ö†Ô∏è Rate limited! Consider waiting 60 seconds or using cached responses.",
			);
		}

		throw new Error(
			`HTTP error! status: ${response.status}, message: ${errorText}`,
		);
	}

	const json = await response.json();
	setCached(cacheKey, json);
	// console.log("üåê GraphQL Response data:", JSON.stringify(json, null, 2));
	return json;
}

try {
	const [currentDataAndList] = await Promise.all([
		hardcoverGraphQL(
			`query getCurrentReadingAndList {
        me {
          user_books(where: { status_id: { _eq: 2 } }) {
            rating
            book {
              id
              title
              contributions {
                author {
                  name
                }
              }
            }
          }
          lists(where: {id: {_eq: 328925}}) {
            id
            name
            books_count
            list_books {
              book {
              	id
                title
                contributions {
                  author {
                    name
                  }
                }
                user_books(
                  where: {user_id: {_eq: 28090}}
                  limit: 1
                  order_by: {updated_at: desc}
                ) {
                  user_book_status {
                    status
                    slug
                  }
                  user_book_reads(limit: 1, order_by: {finished_at: desc_nulls_first}) {
                    started_at
                    finished_at
                  }
                }
              }
            }
          }
        }
      }`,
			{},
			true,
		),
	]);

	currentlyReading = currentDataAndList.data.me[0].user_books || [];
} catch (error) {
	console.error(error);
	// Expected output: ReferenceError: nonExistentFunction is not defined
	// (Note: the exact output may be browser-dependent)
}

// Fetch all data using consolidated utilities
const [recentTracksData] = await Promise.all([
	getRecentTracksWithTags(apiKey, 5),
]);

// Process recent tracks data
if (recentTracksData.recentTracks) {
	recentTracks = recentTracksData.recentTracks;
	recentTrackTags = recentTracksData.recentTrackTags;
}
---

<div class="info-panel__details marquee__content" {ariahidden} x-cloak>
	<!-- Song -->

	{
		recentTracks?.name && recentTracks?.artist?.["#text"] && (
			<div class={`info-panel__detail music relative np-pill--transparent ${recentTracks?.["@attr"]?.nowplaying ? 'np-pill--active' : ''}`}>
					<div class="np-bars">
						<div class="np-bar"></div>
						<div class="np-bar"></div>
						<div class="np-bar"></div>
						<div class="np-bar"></div>
						<div class="np-bar"></div>
	        </div>
				<span>
					<span>{recentTracks?.name}</span> by{" "}
					<span>{recentTracks?.artist?.["#text"]}</span>
				</span>
			</div>
		)
	}
	<!-- Book -->
	<div class="info-panel__detail book">
		<svg class="shrink-0" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
		<span
			><span
				>{currentlyReading[0]?.book.title || "No book currently reading"}</span
			> by <span class="music__artist"
				>{
					currentlyReading[0]?.book.contributions[0].author.name ||
						"Unknown author"
				}</span
			></span
		>
	</div>
	<!-- Weather -->
	<div class="info-panel__detail weather">
		<svg class="shrink-0" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path><circle cx="12" cy="12" r="4"></circle></svg>
		<span class="temp">11¬†¬∞¬†7¬†¬∞</span>
	</div>
	<!-- Time -->
	<div class="info-panel__detail min-w-[125px]">
		<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
		<span class="time"></span>
	</div>
</div>
