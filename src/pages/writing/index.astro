---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import PatternBanner from "../../components/Pattern-Banner.astro";
import { SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";
import DefaultHero from "../../components/DefaultHero.astro";

let posts = [];

if (import.meta.env.ENVIRONMENT === "production") {
	posts = await getCollection("writing", ({ data }) => !data?.draft);
} else {
	posts = await getCollection("writing");
}

posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Extract all unique tags from posts
const allTags = posts.flatMap((post) => post.data.tags);
const categories = [...new Set(allTags)].sort();
const postLength = posts.length;

const growthOptions = [
	{ value: "all", label: "All", description: "All posts" },
	{
		value: "evergreen",
		label: "Evergreen",
		description:
			"Fully vetted, production-ready guides. These features are stable across major browsers and are safe to implement in production today.",
	},
	{
		value: "growing",
		label: "Growing",
		description:
			"Working drafts and stable concepts that are ready for early adoption. Code samples have been tested but are subject to minor changes as specs finalize.",
	},
	{
		value: "seedling",
		label: "Seedling",
		description:
			"Ideas on the edge of the specification. Highly experimental, rough code, and often dependent on browser flags.",
	},
];

const growth = Astro.url.searchParams.get("growth") || "all";
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title="Writing" description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<DefaultHero
				title="Writing"
				description={`I write about technologies that I'm currently diving into, my development on this site, setups and goals. In these ${postLength} posts, I go through problems, solutions and how I am - infact - not Batman.`}
			/>
			<PatternBanner />
			<section
				class="container flow"
				x-data={`{
					growth: '${growth}',
					growthDescription: '${growthOptions.find((option) => option.value === growth)?.description || ""}',
					growthOptions: ${JSON.stringify(growthOptions)},
					category: 'All',
					categoryOptions: ${JSON.stringify(categories)}
				}`}
			>
				<div
					class="flex flex-col md:flex-row justify-between items-baseline h-fit gap-[16px] md:gap-[32px]"
				>
					<div
						class="flex gap-[16px] items-center max-w-[100%] md:max-w-[80%] pt-[var(--space-xl)] relative"
					>
						<span class="h3" data-category=""> Topics </span>
						<div class="category-filters hide-scroll">
							<button
								class="category-filter"
								data-category="All"
								@click.prevent={`category = 'All'`}
								:class="{ active: category === 'All' }"
							>
								All
							</button>
							{
								categories.map((category) => (
									<button
										class="category-filter"
										data-category={category}
										@click.prevent={`category = '${category}'`}
										:class={`{ 'active': category === '${category}' }`}
									>
										{category}
									</button>
								))
							}
						</div>
					</div>
					<div class="max-md:w-full shrink-0">
						<select
							class="px-[var(--space-m)] py-[var(--space-s)] border border-solid cursor-pointer hover:bg-black hover:text-white transition-colors min-w-fit max-md:w-full"
							x-on:change="growth = $event.target.value; growthDescription = growthOptions.find(option => option.value === growth)?.description || ''; console.log('Growth dropdown is:' + growth);"
						>
							{
								growthOptions.map((option) => (
									<option
										value={option.value}
										x-bind:selected={`growth === '${option.value}'`}
									>
										{option.label}
									</option>
								))
							}
						</select>
					</div>
				</div>
				<div class="my-[var(--space-m)] flex" style="--flow-space: 32px;">
					<div x-text="growthDescription || ''"></div>
				</div>
				<ol class="!pb-[56px] post-list flow max-md:mx-[-16px]" style="--flow-space: 0;">
					{
						posts.map((post) => (
							<li
								class="post-item"
								x-data="{ direction: 'top', exitDirection: 'top', isHovered: false }"
								@mouseenter="
									const rect = $el.getBoundingClientRect();
									const y = event.clientY - rect.top;
									const height = rect.height;
									direction = y < height / 2 ? 'top' : 'bottom';
									isHovered = true;
								"
								@mouseleave="
									const rect = $el.getBoundingClientRect();
									const y = event.clientY - rect.top;
									const height = rect.height;
									exitDirection = y < height / 2 ? 'top' : 'bottom';
									isHovered = false;
								"
								x-show={`(growth === '${post.data.growth || "all"}' || growth === "all") && (${JSON.stringify(post.data.tags)}.includes(category) || category === "All")`}
								data-tags={JSON.stringify(post.data.tags)}
							>
								<div class="post"
									x-bind:class="{
										'post--hover-top': isHovered && direction === 'top',
										'post--hover-bottom': isHovered && direction === 'bottom',
										'post--exit-top': !isHovered && exitDirection === 'top',
										'post--exit-bottom': !isHovered && exitDirection === 'bottom'
									}"
								>
									<div class="flex max-md:flex-col-reverse justify-between md:items-center">
											<a
												class="block max-md:mt-[8px] md:mb-[4px] box-link opacity-[0.85] shrink-0 md:max-w-[65%]"
												href={`/writing/${post.id}/`}
											>
												<h4 class="h3">{post.data.title}</h4>
											</a>
											<div class="flex gap-x-[16px] gap-y-[var(--space-m)] transition-opacity duration-300 flex-wrap">
												<!-- <ul class="cluster [--gutter:var(--space-s)] md:ml-auto">
													{post.data.tags.map((tag) => (
														<li>
															<span class="border py-1 px-4 min-w-fit">{tag}</span>
														</li>
													))}
												</ul> -->
												<div class="flex gap-x-[var(--space-m)]">
													<!-- <span class="w-fit md:w-auto">
														{getReadingTime(post.body)} min
													</span> -->
													<span class="w-fit md:w-auto italic">
														<FormattedDate date={post.data.pubDate} />
													</span>
												</div>
											<!-- </div> -->
											<!-- <p class="opacity-[0.85] body-text">
												{post.data.description}
											</p> -->
										</div>
									</div>
								</div>
							</li>
						))
					}
				</ol>
			</section>
		</main>
		<PatternBanner fill="rgba(0, 0, 0, 0.64)" />
	</body>
</html>
