---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PatternBanner from '../../components/Pattern-Banner.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import { getReadingTime } from '../../utils/utils.mjs';
import DefaultHero from '../../components/DefaultHero.astro';


let posts = [];

if (import.meta.env.DEV && import.meta.env.DEV === "false") {
    console.log('DEV');
    posts = await getCollection("writing",
        ({ data }) => !data?.draft
    );
} else {
    posts = await getCollection("writing");
}

posts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Extract all unique tags from posts
const allTags = posts.flatMap(post => post.data.tags);
const categories = [...new Set(allTags)].sort();

---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="relative overflow-clip pb-[64px]">
            <DefaultHero title="Writing" description="I write about technologies that I'm currently diving into, my development on this site, setups and goals. In these {posts.length} posts, I go through problems, solutions and how I am - infact - not Batman." />
            <PatternBanner />
			<section class="container">
                <div class="overflow-auto cluster md:ml-auto pt-[32px] md:max-w-[66%]" style="--gutter: 8px; --cluster-horizontal-alignment: flex-end">
                    <span
                        class="category-filter border py-1 px-4 cursor-pointer hover:bg-black hover:text-white transition-colors active"
                        data-category=""
                    >
                        All
                    </span>
                    {categories.map((category) => (
                        <span
                            class="category-filter border py-1 px-4 cursor-pointer hover:bg-black hover:text-white transition-colors min-w-fit"
                            data-category={category}
                        >
                            {category}
                        </span>
                    ))}
                </div>
                <ol class="!pt-[64px] !pb-[56px] post-list flow" style="--flow-space: 32px;">
                    {
                        posts.map((post) => (
                        <li
                            class="post-item"
                            data-tags={JSON.stringify(post.data.tags)}
                        >
                            <div class="border-b border-black pb-[32px] flex flex-col gap-y-[12px] group relative opacity-[0.5] hover:opacity-100 transition-opacity duration-300">
                                <div class="flex gap-x-[16px] group-hover:opacity-100 opacity-[0.5] transition-opacity duration-300 mb-[4px]">
                                    <ul class="flex gap-x-[8px]">
                                        {post.data.tags.map((tag) => (
                                            <li>
                                                <span class="border py-1 px-4">{tag}</span></li>
                                        ))}
                                    </ul>
                                    <span>{getReadingTime(post.body)} min</span>
                                    <FormattedDate date={post.data.pubDate} />
                                </div>
                                <div class="flex justify-between">
                                    <div class="flex flex-col gap-y-[8px]">
                                        <a class="h2 block mb-[4px] box-link" href={`/writing/${post.id}/`}>
                                            <h4>{post.data.title}</h4>
                                        </a>
                                        <p class="opacity-[0.85] body-text">{post.data.description}</p>
                                    </div>
                                </div>
                            </div>
                        </li>
                        ))
                    }
                </ol>
			</section>
		</main>
		<PatternBanner fill="rgba(0, 0, 0, 0.64)" />
	</body>
</html>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoryFilters = document.querySelectorAll('.category-filter');
        const postItems = document.querySelectorAll('.post-item');

        // Add opacity-100 to first post on initial load
        if (postItems.length > 0) {
            postItems[0].classList.add('opacity-100');
        }

        categoryFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                const selectedCategory = this.getAttribute('data-category');
                console.log('Selected category:', selectedCategory);

                // Update active state
                categoryFilters.forEach(f => f.classList.remove('active'));
                this.classList.add('active');

                // Filter posts
                postItems.forEach(post => {
                    post.classList.remove('opacity-100');
                });

                let firstVisible = true;
                postItems.forEach(post => {
                    const tagsAttr = post.getAttribute('data-tags');
                    const postTags = tagsAttr ? JSON.parse(tagsAttr) : [];
                    console.log('Post tags:', postTags);

                    if (selectedCategory === '' || postTags.includes(selectedCategory)) {
                        post.style.display = 'flex';
                        if (firstVisible) {
                            post.classList.add('opacity-100');
                            firstVisible = false;
                        }
                        console.log('Showing post');
                    } else {
                        post.style.display = 'none';
                        console.log('Hiding post');
                    }
                });
            });
        });
    });
</script>

<style>
    .post-item.opacity-100:first-of-type {
        opacity: 1 !important;
    }

    .category-filter.active {
        background-color: black;
        color: white;
    }
</style>
