---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import PatternBanner from "../../components/Pattern-Banner.astro";
import FeatureListItem from "../../components/FeatureListItem.astro";
import { SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";
import DefaultHero from "../../components/DefaultHero.astro";

let posts = [];

if (import.meta.env.ENVIRONMENT === "production") {
	posts = await getCollection("writing", ({ data }) => !data?.draft);
} else {
	posts = await getCollection("writing");
}

posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Extract all unique tags from posts
const allTags = posts.flatMap((post) => post.data.tags);
const categories = [...new Set(allTags)].sort();
const tagCounts = Object.fromEntries(
	categories.map((tag) => [
		tag,
		posts.filter((post) => post.data.tags?.includes(tag)).length,
	]),
);
const postLength = posts.length;

const growthOptions = [
	{ value: "all", label: "All", description: "All posts" },
	{
		value: "evergreen",
		label: "Evergreen",
		description:
			"Fully vetted, production-ready guides. These features are stable across major browsers and are safe to implement in production today.",
	},
	{
		value: "growing",
		label: "Growing",
		description:
			"Working drafts and stable concepts that are ready for early adoption. Code samples have been tested but are subject to minor changes as specs finalize.",
	},
	{
		value: "seedling",
		label: "Seedling",
		description:
			"Ideas on the edge of the specification. Highly experimental, rough code, and often dependent on browser flags.",
	},
];

const growth = Astro.url.searchParams.get("growth") || "all";
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title="From the Desk of Dom Jay" description={SITE_DESCRIPTION} />
	</head>
	<body>
		<div id="cur"></div>
		<Header />
		<main>
			<DefaultHero
				title="From the Desk"
				description={`I write about technologies that I'm currently diving into, my development on this site, setups and goals. In these ${postLength} posts, I go through problems, solutions and how I am - infact - not Batman.`}
			/>
			<PatternBanner />
			<section
				class="container flow"
				x-data={`{
					growth: '${growth}',
					growthDescription: '${growthOptions.find((option) => option.value === growth)?.description || ""}',
					growthOptions: ${JSON.stringify(growthOptions)},
					category: 'All',
					categoryOptions: ${JSON.stringify(categories)}
				}`}
			>
				<!-- <div class="flex flex-col md:flex-row justify-between items-baseline h-fit gap-[var(--space-m)] md:gap-[var(--space-xl)] pt-[var(--space-m)] md:pt-[var(--space-xl)]">
					<div class="max-md:w-full shrink-0 flex items-center gap-x-[var(--space-m)]">
						<select
							class="px-[var(--space-m)] py-[var(--space-s)] border border-solid cursor-pointer hover:bg-black hover:text-white transition-colors min-w-fit max-md:w-full"
							x-on:change="growth = $event.target.value; growthDescription = growthOptions.find(option => option.value === growth)?.description || ''; console.log('Growth dropdown is:' + growth);"
						>
							{
								growthOptions.map((option) => (
									<option
										value={option.value}
										x-bind:selected={`growth === '${option.value}'`}
									>
										{option.label}
									</option>
								))
							}
						</select>
						<div class="flex-1">
							<div class="search-wrap">
				        <span class="search-icon">⌕</span>
				        <input type="text" class="search-input" id="searchInput" placeholder="Search posts…" autocomplete="off" spellcheck="false">
				      </div>
						</div>
						<span class="results-count" id="resultsCount">35 posts</span>
					</div>
				</div> -->
				<div class="!grid grid-cols-4 gap-[var(--space-m)]">
					<div class="col-span-full md:col-span-3 max-md:w-full shrink-0 flex items-end gap-x-[var(--space-m)] pt-[var(--space-m)] md:pt-[var(--space-xl)]">
						<select
							class="px-[var(--space-m)] py-[var(--space-s)] border border-dashed hover:border-solid cursor-pointer min-w-fit max-md:w-full"
							x-on:change="growth = $event.target.value; growthDescription = growthOptions.find(option => option.value === growth)?.description || ''; console.log('Growth dropdown is:' + growth);"
						>
							{
								growthOptions.map((option) => (
									<option
										value={option.value}
										x-bind:selected={`growth === '${option.value}'`}
									>
										{option.label}
									</option>
								))
							}
						</select>
						<div class="flex-1 h-full">
							<div class="search-wrap">
				        <span class="search-icon">⌕</span>
				        <input type="text" class="search-input" id="searchInput" placeholder="Search posts…" autocomplete="off" spellcheck="false">
				      </div>
						</div>
						<span class="results-count" id="resultsCount">35 posts</span>
					</div>
					<ol class="!pb-[56px] post-list feature-list flow col-span-full md:col-span-3" style="--flow-space: 0;">
						{
							posts.map((post, i) => (
								<FeatureListItem
									i={String(i + 1).padStart(2, "0")}
									title={post.data.title}
									description={post.data.description}
									tags={post.data.tags}
									pubDate={post.data.pubDate}
									url={post.url}
									growth={post.data.growth}
								/>
							))
						}
						<li id="emptyState" class="hidden col-span-full py-[var(--space-xl)] text-center opacity-70" aria-live="polite">
							No posts match your filters.
						</li>
					</ol>
					<div
						class="col-span-full md:col-span-1 relative"
					>
						<div class="md:sticky md:top-[120px]">
							<span class="h3" data-category=""> Topics </span>
							<div id="sideTopics" class="flex max-md:flex-wrap md:flex-col gap-x-[var(--space-m)] gap-y-[var(--space-s)] pt-[var(--space-m)]">
								<button
									class="category-filter w-fit"
									data-category="All"
									@click.prevent={`category = 'All'`}
									:class="{ active: category === 'All' }"
								>
									all
								</button>
								{
									categories.map((category) => (
										<button
											class="category-filter lowercase w-fit"
											data-category={category}
											@click.prevent={`category = '${category}'`}
											:class={`{ 'active': category === '${category}' }`}
										>
											{category} <span class="opacity-60">({tagCounts[category]})</span>
										</button>
									))
								}
							</div>
						</div>
					</div>
				</div>
			</section>
		</main>
		<PatternBanner fill="rgba(0, 0, 0, 0.64)" />
	</body>
	<script>
		document.addEventListener("mousemove", (e) => {
			const cur = document.getElementById("cur");
			if (cur) {
				cur.style.left = e.clientX + "px";
				cur.style.top = e.clientY + "px";
			}
		});
		document.querySelectorAll("a, button, .post-item").forEach((el) => {
			el.addEventListener("mouseenter", () =>
				document.body.classList.add("cur-lg"),
			);
			el.addEventListener("mouseleave", () =>
				document.body.classList.remove("cur-lg"),
			);
		});
		document.querySelectorAll(".prose, .body, .intro").forEach((el) => {
			el.addEventListener("mouseenter", () =>
				document.body.classList.add("cur-sm"),
			);
			el.addEventListener("mouseleave", () =>
				document.body.classList.remove("cur-sm"),
			);
		});

		let searchQuery = '';

		const section = document.querySelector('.container.flow');
		const getItems = () => section ? section.querySelectorAll('.post-item') : [];

		function applyFilters() {
		  const items = getItems();
		  const activeStage = section?.querySelector('select')?.value ?? 'all';
		  const activeTopic = section?.querySelector('.category-filter.active')?.dataset.category ?? 'All';
		  let visible = 0;
		  items.forEach(item => {
		    const stageOk  = activeStage === 'all' || item.dataset.stage === activeStage;
		    const topicOk  = activeTopic === 'All' || (item.dataset.topics || '').split(',').map(t => t.trim()).includes(activeTopic);
		    const searchOk = !searchQuery || (item.dataset.title || '').includes(searchQuery.toLowerCase());

		    const show = stageOk && topicOk && searchOk;
		    item.classList.toggle('hidden', !show);

		    if (show) {
		      item.classList.remove('visible');
		      setTimeout(() => item.classList.add('visible'), visible * 26);
		      visible++;
		    }
		  });

		  const resultsEl = document.getElementById('resultsCount');
		  if (resultsEl) resultsEl.textContent = visible + ' posts';
		  const emptyEl = document.getElementById('emptyState');
		  if (emptyEl) emptyEl.style.display = visible === 0 ? 'block' : 'none';
		}

		document.getElementById('searchInput').addEventListener('input', e => {
		  searchQuery = e.target.value.trim();
		  applyFilters();
		});

		section?.addEventListener('click', (e) => {
		  if (e.target.closest('.category-filter')) applyFilters();
		});

		section?.querySelector('select')?.addEventListener('change', applyFilters);

		applyFilters();

		// Stagger reveal
		const items=postList.querySelectorAll('.post-item');
		const obs=new IntersectionObserver(entries=>{
		  entries.forEach(e=>{if(!e.isIntersecting)return;const i=[...items].indexOf(e.target);setTimeout(()=>e.target.classList.add('visible'),i*26);obs.unobserve(e.target);});
		},{threshold:.05});
		items.forEach(el=>obs.observe(el));
	</script>
</html>
