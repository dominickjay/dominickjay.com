---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import FormattedDate from '../components/FormattedDate.astro';
import PatternBanner from '../components/Pattern-Banner.astro';
import Footer from '../components/Footer.astro';
import MusicCard from '../components/MusicCard.astro';
import ArtistCard from '../components/ArtistCard.astro';
import { Image } from 'astro:assets';
import { SITE_TITLE, SITE_DESCRIPTION, SITE_TAGLINE } from '../consts';
import moment from "moment";
import {
  getWeeklyArtistChart,
  getWeeklyTrackChart,
  enrichArtistsWithInfo,
  getRecentTracksWithTags,
  type LastFmArtist,
  type LastFmTrack,
  type LastFmTag
} from '../lib/lastfm';

let artists: LastFmArtist[] = [];
let tracks: LastFmTrack[] = [];
let recentTracks: LastFmTrack | null = null;
let recentTrackTags: LastFmTag[] = [];
let trackColor = '#000000'; // Default color
let currentArtistPlaycount: string | null = null;

const weekAgo = moment().subtract(4, 'weeks').unix();
const now = moment().unix();
const apiKey = import.meta.env.LAST_FM_API_KEY;

// Fetch all data using consolidated utilities
const [artistResponse, trackResponse, recentTracksData] = await Promise.all([
  getWeeklyArtistChart(weekAgo.toString(), now.toString(), apiKey, 20),
  getWeeklyTrackChart(weekAgo.toString(), now.toString(), apiKey, 10),
  getRecentTracksWithTags(apiKey, 5)
]);

// Process artist data
if (artistResponse.weeklyartistchart?.artist) {
  artists = await enrichArtistsWithInfo(artistResponse.weeklyartistchart.artist, apiKey);
}

// Process track data
if (trackResponse.weeklytrackchart?.track) {
  tracks = trackResponse.weeklytrackchart.track;
}

// Process recent tracks data
if (recentTracksData.recentTracks) {
  recentTracks = recentTracksData.recentTracks;
  recentTrackTags = recentTracksData.recentTrackTags;
}

// Derive the total playcount for the current artist if available
if (recentTracks && recentTracks.artist && recentTracks.artist['#text'] && artists.length > 0) {
  const match = artists.find(a => a.name === recentTracks!.artist['#text']);
  if (match) {
    currentArtistPlaycount = (match.info?.stats?.userplaycount
      || (match as any).stats?.userplaycount
      || null) as string | null;
  }
}

---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
            <div class="container flex flex-col md:flex-row gap-[32px] md:gap-[64px] py-[32px] md:py-[64px]">
                <div class="md:sticky top-[185px] h-fit shrink-0">
                    <span class="h3 mb-[24px] block">Top 10 Tracks</span>
                    <div class="flex flex-col gap-[12px]">
                        { tracks.map((track, i) => (
                            <div class="flex flex-col gap-[3px]">
                                <span class="font-semibold">{track.name}</span>
                                <span class="text-[1rem]">{track.artist['#text']}</span>
                            </div>
                            )
                        )}
                    </div>
                </div>
                <div class="flex flex-col gap-[20px] w-full">
                    <div class="grid !grid-cols-1 md:!grid-cols-2 mdw:grid-cols-4 gap-[20px]">
                        <div class="col-start-1 col-span-4 grid !grid-cols-4 gap-[20px]">
                            <h1 class="h2 col-span-full">Currently Playing</h1>
                            {recentTracks && (
                                <div class="col-span-full md:col-span-2 flex" style={`--track-color: ${trackColor}`}>
                                    <MusicCard
                                        track={recentTracks}
                                        tags={recentTrackTags}
                                        trackColor={trackColor}
                                        index={0}
                                        artistPlaycount={currentArtistPlaycount ?? undefined}
                                    />
                                </div>
                            )}
                            <!-- <div class="col-span-1 flex flex-col gap-[6px] p-4 border">
                                {recentTracks.image && recentTracks.image[2] && (
                                    <img
                                        src={recentTracks.image[2]['#text']}
                                        alt={`${recentTracks.name} album cover`}
                                        class="w-full h-fit aspect-square object-cover mb-2"
                                        loading="lazy"
                                    />
                                )}
                                <span class="">{recentTracks.name}</span>
                                <span class="">{recentTracks.artist['#text']}</span>
                                {recentTracks['@attr']?.nowplaying && (
                                    <span class="rounded-full border border-solid border-solid  px-4 py-2 flex items-center justify-center text-center font-semibold">Now Playing</span>
                                )}
                            </div> -->
                        </div>
                    </div>
                    <!-- <div class="grid !grid-cols-4 gap-[20px] pt-[137px] container">
                        <div class="col-span-1">
                            <h1 class="h2">Recent Favorite</h1>
                        </div>
                        <div class="col-start-2 col-span-3 grid !grid-cols-2 gap-[20px]">
                            <div class="col-span-1 flex gap-[6px]">
                                <span class="">{lovedTracks[0].name}</span>-<span class="">{lovedTracks[0].artist.name}</span>
                            </div>
                        </div>
                    </div> -->
                    <div class="grid !grid-cols-4 gap-[20px] pt-[68px]">
                        <div class="col-start-1 col-span-4 grid !grid-cols-4 !gap-[8px] md:!gap-[20px]">
                            <h1 class="h2 col-span-full">Recent Artists</h1>
                            { artists
                                .sort((a, b) => {
                                    // Check if recentTracks exists and has the required structure
                                    if (!recentTracks || !recentTracks.artist || !recentTracks.artist['#text']) {
                                        return 0; // No sorting if no recent track data
                                    }

                                    const aIsNowPlaying = recentTracks.artist['#text'] === a.name && recentTracks['@attr']?.nowplaying;
                                    const bIsNowPlaying = recentTracks.artist['#text'] === b.name && recentTracks['@attr']?.nowplaying;

                                    // Return 1 if b should come first, -1 if a should come first, 0 if equal
                                    if (aIsNowPlaying && !bIsNowPlaying) return -1;
                                    if (!aIsNowPlaying && bIsNowPlaying) return 1;
                                    return 0;
                                })
                                .map((artist, i) => {
                                const isNowPlaying = Boolean(recentTracks && recentTracks.artist && recentTracks.artist['#text'] === artist.name && recentTracks['@attr']?.nowplaying);
                                return (
                                <div class="col-span-full md:col-span-1 flex" style={`--track-color: ${trackColor}`}>
                                    <ArtistCard
                                        artist={artist}
                                        isNowPlaying={isNowPlaying}
                                        trackColor={trackColor}
                                        index={i}
                                    />
                                </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            </div>
		</main>
		<PatternBanner fill="rgba(0, 0, 0, 0.64)" />
	</body>
</html>

<script>
    import ColorThief from 'colorthief';
    import { initializeColorExtraction } from '../lib/colorExtraction';

    // Make ColorThief available globally
    (window as any).ColorThief = ColorThief;

    // Initialize color extraction
    initializeColorExtraction();
</script>
