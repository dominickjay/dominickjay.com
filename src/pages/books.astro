---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import FormattedDate from '../components/FormattedDate.astro';
import PatternBanner from '../components/Pattern-Banner.astro';
import Footer from '../components/Footer.astro';
import { Image } from 'astro:assets';
import { SITE_TITLE, SITE_DESCRIPTION, SITE_TAGLINE } from '../consts';
import moment from "moment";

let currentBooks = [];
let finishedBooks = [];
let readBooks = [];
let toReadBooks = [];

try {
  const response = await fetch("https://literal.club/graphql/",
    {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
          query: `query booksByReadingStateAndProfile(
          $limit: Int!
          $offset: Int!
          $readingStatus: ReadingStatus!
          $profileId: String!
        ) {
          booksByReadingStateAndProfile(
              limit: $limit
              offset: $offset
              readingStatus: $readingStatus
              profileId: $profileId
          )
          { id title cover authors {
              name
          } } }`,
          variables: {
              "limit": 100,
              "offset": 0,
              "readingStatus": "WANTS_TO_READ",
              "profileId": import.meta.env.profileId
          },
      }),
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  const data = await response.json();
  toReadBooks = data.data?.booksByReadingStateAndProfile || [];
} catch (error) {
  console.error('Error fetching to-read books from Literal.club:', error);
  toReadBooks = [];
}

try {
  const response = await fetch("https://literal.club/graphql/",
    {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
          query: `query booksByReadingStateAndProfile(
          $limit: Int!
          $offset: Int!
          $readingStatus: ReadingStatus!
          $profileId: String!
        ) {
          booksByReadingStateAndProfile(
              limit: $limit
              offset: $offset
              readingStatus: $readingStatus
              profileId: $profileId
          )
          { id title cover authors {
              name
          } } }`,
          variables: {
              "limit": 100,
              "offset": 0,
              "readingStatus": "IS_READING",
              "profileId": import.meta.env.profileId
          },
      }),
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  const data = await response.json();
  currentBooks = data.data?.booksByReadingStateAndProfile || [];
} catch (error) {
  console.error('Error fetching currently reading books from Literal.club:', error);
  currentBooks = [];
}

async function getBooks() {
  try {
    const response = await fetch("https://literal.club/graphql/", {
      method: "POST",
      body: JSON.stringify({
        query: `query booksByReadingStateAndProfile(
        $limit: Int!
        $offset: Int!
        $readingStatus: ReadingStatus!
        $profileId: String!
      ) {
        booksByReadingStateAndProfile(
            limit: $limit offset: $offset readingStatus: $readingStatus profileId: $profileId) {
            id title cover authors { name } } }`,
        variables: {
          limit: 100,
          offset: 0,
          readingStatus: "FINISHED",
          profileId: import.meta.env.profileId,
        },
      }),
      headers: {
        "Content-Type": "application/json",
        authorization: import.meta.env.literalToken ?? "",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json() as any;
    const books = new Map<number, any>();

    for (const book of data.data?.booksByReadingStateAndProfile || []) {
      try {
        const datesResponse = await fetch("https://literal.club/graphql/", {
          method: "POST",
          body: JSON.stringify({
            query: `query getReadDates($bookId: String!, $profileId: String!) {
              getReadDates(bookId: $bookId, profileId: $profileId) {
                started
                finished
              }
            }`,
            variables: {
              bookId: book.id,
              profileId: import.meta.env.profileId,
            },
          }),
          headers: {
            "Content-Type": "application/json",
            authorization: import.meta.env.literalToken ?? "",
          },
        });

        if (!datesResponse.ok) {
          throw new Error(`HTTP error! status: ${datesResponse.status}`);
        }

        const dates = await datesResponse.json() as any;
        const date = dates?.data?.getReadDates?.pop();

        const b = {
          ...book,
          started: date?.started ? date?.started : 'unknown',
          finished: date?.finished ? date?.finished : 'unknown',
        };

        // Include all books regardless of dates
        if (b.finished != null && b.finished !== 'unknown') {
          const year = moment(b.finished).year();

          let read = books.get(year);
          if (read == null) {
            read = [b];
            books.set(year, read);
          } else {
            read.push(b);
          }
        } else {
          // For books without finished dates, use a special year (e.g., 0 or current year)
          const year = 2023; // or new Date().getFullYear() if you prefer current year
          let read = books.get(year);
          if (read == null) {
            read = [b];
            books.set(year, read);
          } else {
            read.push(b);
          }
        }
      } catch (error) {
        console.error(`Error fetching read dates for book ${book.id}:`, error);
        // Continue processing other books even if one fails
        const b = {
          ...book,
          started: 'unknown',
          finished: 'unknown',
        };
        const year = 2023;
        let read = books.get(year);
        if (read == null) {
          read = [b];
          books.set(year, read);
        } else {
          read.push(b);
        }
      }
    }

    return books;
  } catch (error) {
    console.error('Error fetching finished books from Literal.club:', error);
    return new Map<number, any>();
  }
}

const books = await getBooks();

---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
            <div class="container flex flex-col md:flex-row gap-[32px] md:gap-[64px] py-0 md:py-[90px]"
                style="--grid-placement: 12; --gutter: 43px;"
                x-data="{
                    list: true,
                    floatingCover: {
                        show: false,
                        x: 0,
                        y: 0,
                        src: '',
                        title: ''
                    }
                }"
            >
                <div class="md:sticky top-[185px] h-fit shrink-0">
                    <span class="h3 mb-[24px] block">To Read List</span>
                    <div class="flex flex-col gap-[12px] overflow-auto">
                        { toReadBooks.map((book, i) => (
                            <div class="flex flex-col gap-[3px]">
                                <span class="font-semibold">{book.title}</span>
                                {/* <span class="text-[1rem]">{book.author['name']}</span> */}
                            </div>
                            )
                        )}
                    </div>
                </div>
                <div
                    class="flex flex-col gap-[20px] w-full relative"
                    @mousemove="floatingCover.x = $event.clientX + 20; floatingCover.y = $event.clientY + 20"
                    @mouseleave="floatingCover.show = false; floatingCover.src = ''; floatingCover.title = ''"
                >
                    <!-- Floating book cover -->
                    <div
                        x-show="floatingCover.show && floatingCover.src"
                        x-transition.opacity
                        class="fixed pointer-events-none z-50 w-[200px] aspect-[1/1.5] overflow-hidden shadow-lg"
                        :style="`left: ${floatingCover.x}px; top: ${floatingCover.y}px;`"
                    >
                        <div x-show="floatingCover.src" class="relative w-full h-full">
                            <img :src="floatingCover.src" :alt="floatingCover.title" class="w-full h-full object-cover" />
                        </div>
                    </div>
                    <div
                        class="grid !grid-cols-4 gap-[20px]"
                        :class="{
                            'flex flex-col': list,
                            'grid': !list
                        }"
                    >
                        <h2 class="h2 col-span-full mb-[24px]">Currently Reading</h2>
                        <ul
                            class="col-span-full grid gap-y-[12px]"
                            :class="{
                                'flex flex-col': list,
                                'grid': !list
                            }"
                        >
                            {currentBooks.map((book, i) =>
                                <li
                                    class="col-span-2 group"
                                    :class="{
                                        'border-b'
                                    }"
                                    @mouseenter={`floatingCover.show = true; floatingCover.src = ${JSON.stringify(book.cover)}; floatingCover.title = ${JSON.stringify(book.title)}`}
                                    @mouseleave="floatingCover.show = false; floatingCover.src = ''; floatingCover.title = ''"
                                >
                                    <div class="overflow-hidden flex flex-col gap-y-[12px] relative">
                                        <div x-show="!list" class={`overflow-hidden aspect-[1/1.5] ${!book.cover ? 'border' : ''}`}>
                                            {book.cover && <Image class="w-full" src={book.cover} alt={'Cover for ' + book.title} width="200" height="100" />}
                                        </div>
                                        <div
                                            class={`flex flex-col gap-[8px] w-full ${!book.cover ? 'absolute bg-black inset-0 text-white py-[8px] px-[16px] opacity-100' : ''}`}
                                            :class="{
                                                'opacity-0 absolute bg-black inset-0 text-white py-[8px] px-[16px] group-hover:opacity-100': !list
                                            }"
                                        >
                                            <p class="text-[22px]">{ book.title }</p>
                                        </div>
                                    </div>
                                </li>
                            )}
                        </ul>
                    </div>
                    {
                        [...books].map((year, i) => (
                            <ul class="col-span-full">
                                <li>
                                    <div class="flex flex-col gap-y-[24px]">
                                        <h2 class="h2">Books read in {year[0]} <span class="text-[20px] opacity-75">({year[1].length})</span></h2>
                                        <ul
                                            class="col-span-full grid gap-y-[12px]"
                                            :class="{
                                                'flex flex-col': list,
                                                'grid': !list
                                            }"
                                        >
                                            {
                                                [...books][i][1].map((book, index) => (
                                                <li
                                                    class="col-span-2 group"
                                                    :class="{
                                                        'border-b'
                                                    }"
                                                    @mouseenter={`floatingCover.show = true; floatingCover.src = ${JSON.stringify(book.cover)}; floatingCover.title = ${JSON.stringify(book.title)}`}
                                                    @mouseleave="floatingCover.show = false; floatingCover.src = ''; floatingCover.title = ''"
                                                >
                                                        <div class="overflow-hidden flex flex-col gap-y-[12px] relative">
                                                            <div
                                                                class="flex flex-col gap-[8px]w-full"
                                                                :class="{
                                                                    'opacity-0  absolute bg-black inset-0 text-white py-[8px] px-[16px] group-hover:opacity-100': !list
                                                                }"
                                                            >
                                                                <p class="text-[22px]">{book.title}</p>
                                                                <div
                                                                    class="mt-auto pb-[8px] flex flex-col"
                                                                    :class="{
                                                                        'flex-row gap-x-[20px] items-center mt-[8px]': list,
                                                                    }"
                                                                >
                                                                    {book.started != book.finished && book.started !== 'unknown' && book.finished !== 'unknown' && (
                                                                        // <p>{new Date(book.started)}</p>
                                                                        <span class="text-[16px]">Started: <FormattedDate date={new Date(book.started)} /></span>
                                                                    )}
                                                                        <span class="text-[16px] pt-[2px]">
                                                                            Finished: {book.finished !== 'unknown' ? <FormattedDate date={new Date(book.finished)} /> : 'Unknown date'}
                                                                        </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                ))
                                            }
                                        </ul>
                                    </div>
                                </li>
                            </ul>

                        ))
                    }
                    </div>
                </div>
            </div>
		</main>
		<PatternBanner fill="rgba(0, 0, 0, 0.64)" />
	</body>
</html>
