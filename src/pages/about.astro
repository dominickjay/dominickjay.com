---
import Layout from "../layouts/Default.astro";
import MusicCard from "../components/MusicCard.astro";
import Profile from "../components/Profile.astro";
import Joke from "../components/Joke.astro";
import Companies from "../components/Companies.astro";
import Testimonials from "../components/Testimonials.astro";
import MarqueeHeading from "../components/MarqueeHeading.astro";
import ScrollHeading from "../components/ScrollHeading.astro";
import type {
	LastFmResponse,
	LastFmTrack,
	LastFmAlbum,
	LastFmTag,
} from "../lib/lastfm";
import {
	getWeeklyAlbumChart,
	enrichAlbumsWithImages,
	getRecentTracksWithTags,
} from "../lib/lastfm";
import moment from "moment";
import { Image } from "astro:assets";
import { ABOUT_INTRO, ABOUT_CONTENT, ABOUT_COMPANIES } from "../consts";

const showMarquee = true;
const contentIntro = ABOUT_INTRO.medium
	.replaceAll("[", '<span class="current-job">')
	.replaceAll("]", "</span>");
const contentWithBreaks = ABOUT_CONTENT.long
	.replace(/\n/g, "<br>")
	.replaceAll("[", '<span class="current-job">')
	.replaceAll("]", "</span>");

const companies = ABOUT_COMPANIES;

interface Props {
	musicData?: LastFmResponse | null;
}

let musicData = Astro.props.musicData;

let recentTracks: LastFmTrack | null = null;
let recentTrackTags: LastFmTag[] = [];
let trackColor = "#000000"; // Default color
let albumCovers: LastFmAlbum[] = [];

const weekAgo = moment().subtract(4, "week").unix();
const now = moment().unix();
const apiKey = import.meta.env.LAST_FM_API_KEY;

// Fetch album data
const albumData = await getWeeklyAlbumChart(
	weekAgo.toString(),
	now.toString(),
	apiKey,
	60,
);
if (albumData?.error) {
	console.error("Last.fm API error:", albumData.message);
} else if (albumData?.weeklyalbumchart?.album) {
	// Enrich albums with images
	albumData.weeklyalbumchart.album = await enrichAlbumsWithImages(
		albumData.weeklyalbumchart.album,
		apiKey,
	);
	albumCovers = albumData.weeklyalbumchart.album;
	// console.log('album covers:', albumCovers.length, 'albums found');
}

// Fetch recent tracks with tags using consolidated utility
const recentTracksData = await getRecentTracksWithTags(apiKey, 5);
if (recentTracksData.recentTracks) {
	recentTracks = recentTracksData.recentTracks;
	recentTrackTags = recentTracksData.recentTrackTags;
}
---

{/* @ts-ignore */}
<Layout
	{...{
		title: "About Me",
		description: "creative front end developer, writer, music nerd.",
		pubDate: new Date("August 08 2021"),
		tags: [],
		headings: [],
		timeToRead: 0,
	} as any}
>
	<div class="about flow">
		<div
			class="grid grid-cols-6 container"
			style="--grid-placement: 6; --gutter: 43px;"
		>
			<div class="col-span-full md:col-span-2">
				<Profile />
			</div>
			<div class="col-span-full md:col-span-4 flow">
				<!-- <fieldset class="border border-b-[2px] border-dark w-fit pl-[24px] pr-[48px] pb-[24px] flow">
                    <legend class="h5">Choose your length</legend>
                    <div class="repel" data-nowrap>
                        <template x-for="option in options" :key="option.id">
                            <label class="centered relative" :class="{ 'checked': selected === option.id }">
                                <input
                                    type="radio"
                                    name="content-length"
                                    :value="option.id"
                                    x-model="selected"
                                    class="mr-2"
                                >
                                <span x-text="option.label"></span>
                            </label>
                        </template>
                    </div>
                </fieldset> -->

				<div class="flow">
					<div class="overflow-clip">
						{showMarquee && <MarqueeHeading title="About" />}
						{!showMarquee && <ScrollHeading title="About" />}
					</div>
					<h2 class="h2" set:html={contentIntro} />
					<div
						class="intro flow [--flow-space:var(--space-s)] pt-[var(--space-l)]"
					>
						<p>
							I sit at the intersection of design, anthropology, and web
							development. These three are at the core of everything I make.
							Combining them into a coherent career is a weird and ongoing
							challenge.
						</p>
						<p>
							Titles and disciplines are fickle and fleeting. But my work fits
							under the umbrellas of design engineering, product design, and
							visual interface design. With some cultural analysis, writing, and
							visual illustration sprinkled on top.
						</p>
					</div>
					<div class="[--flow-space:var(--space-m)]">
						<p>
							I currently work at {companies[0].label}, exploring the many,
							messy, murky problems around how AI is changing software
							engineering. Here's what I've been up to for the last few years:
							<ul
								class="flex flex-col gap-[var(--space-m)] mt-[var(--space-m)]"
							>
								{
									companies.map((company) => (
										<li>
											<div class="flow [--flow-space:var(--space-s)]">
												<span class="">
													<span class="h4">{company.jobTitle}</span> at
													<span class="intro">{company.label}</span>
												</span>
												<div class="">{company.content}</div>
											</div>
										</li>
									))
								}
							</ul>
						</p>
					</div>
					<div class="">
						<p>
							On the side I create illustrated essays and visual explanations
							about programming and culture. I'm an advocate of digital
							gardening , end-user programming , and expanding our use of
							embodied cognition and conceptual metaphors in digital interfaces.
						</p>
					</div>
					<div class="">
						<h3 class="h3">Personal Interests</h3>
						<p>
							Outside of work I like <a href="/books">reading</a>, listening to <a
								href="/music">music</a
							> and playing either the guitar, the ukulele, or the drums - having
							self taught them all. I try to hit the gym as often as I can.
						</p>
					</div>

					<!-- <Joke />
                <div class="flex flex-col gap-[24px]">
                    <h2 class="h3 mb-[24px]">Recent Albums</h2>
                    <div class="grid !grid-cols-3 md:!grid-cols-6 gap-0 relative" style="--gutter: 8px">
                        {albumCovers.slice(0, 5).map(async (album: LastFmAlbum) => {
                            const hasValidImage = album.image?.length > 0 && album.image[0]['#text'] && album.image[0]['#text'].length > 0;
                            if (!hasValidImage) {
                                return null;
                            }

                            return (
                                <div class="col-span-1 opacity-[0.7] bg-album-cover">
                                    <img
                                        src={album.image[3]['#text']}
                                        alt={`Cover for ${album.name}`}
                                        class="w-full h-auto aspect-square object-cover"
                                        onerror="this.onerror=null; this.src='/images/album-placeholder.png';"
                                        width="200"
                                        height="200"
                                        loading="lazy"
                                    />
                                </div>
                            );
                        })}
                        <div class="col-span-full">
                            {recentTracks && (
                                <MusicCard
                                    track={recentTracks}
                                    tags={recentTrackTags}
                                    trackColor={trackColor}
                                />
                            )}
                        </div>
                    </div>
                </div> -->
					<Testimonials />
				</div>
			</div>

			<!-- <Companies /> -->
		</div>
	</div>

	<script>
		import ColorThief from "colorthief";
		import { initializeColorExtraction } from "../lib/colorExtraction";

		// Make ColorThief available globally
		(window as any).ColorThief = ColorThief;

		// Initialize color extraction
		initializeColorExtraction();
	</script>

	<style>
		.bg-album-cover:hover {
			opacity: 1;
			transition: opacity 0.3s ease-in-out;
		}
	</style>
</Layout>
